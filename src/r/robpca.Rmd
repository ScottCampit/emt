---
title: "Robust PCA data filtering"
author: "Scott Campit"
output: html_notebook
---

# Summary

# 1. Load libraries
```{r}
library(tidyr)
library(readr)
library(stringr)
library(ggplot2)
library(reticulate)
library(limma)
library(Glimma)
library(edgeR)
library(tidyverse)
library(dplyr)
library(reshape2)
library(readxl)
library(ggVennDiagram)
library(rrcov)
```

# 2. Read in data
```{r}
rm(list=ls())

# Dell
datapath = 'D:/Data/CRISPR/Achilles/Achilles_gene_effect.csv'

# Linux
#datapath = '~/Data/CRISPR/Achilles_gene_effect.csv'

# Read in data
data = readr::read_csv(datapath)
```
## Grab CCLE meta data
First, we'll get relevant meta data
```{r}
# Linux
#metapath = "~/Data/CRISPR/sample_info.csv"

# Dell
metapath = 'D:/Data/Mappings/CCLE/sample_info.csv'

# Read in meta data
meta_data = read_csv(metapath)
meta_data = meta_data[, c("DepMap_ID", 
                        "stripped_cell_line_name", 
                        "primary_or_metastasis",
                        "lineage",
                        "lineage_subtype")]
```

# 3. Dimension reduction
First, we'll grab the CERES Scores.
```{r}
ceres = data[, 2:ncol(data)]
ceres = data.matrix(ceres)
ceres[is.na(ceres)] = 0
ceres = as.matrix(ceres)
ids = data.frame(data[, 1])
```

First, we'll create a function that can perform ROBPCA on the data.
```{r}
# Create a function that filters data using ROBPCA
removeOutliers = function(data, id){
  pca_obj = PcaHubert(data)
  filtered_data = data[pca_obj@flag, ]
  filtered_id = id[pca_obj@flag,]
  outlier_data = data[!pca_obj@flag, ]
  outlier_id = id[!pca_obj@flag,]
  
  setClass(Class="geneObj",
           representation(
             data="matrix",
             outlier_data="matrix",
             id="character",
             flag="logical",
             outlier_id="character",
             robpca='PcaHubert'
           )
   )
   return(new("geneObj",
          data=filtered_data,
          outlier_data=outlier_data,
          id=filtered_id,
          flag=pca_obj@flag,
          outlier_id=outlier_id,
          robpca=pca_obj))
}
```

## Perform PCA
```{r}
pca_obj = prcomp(ceres, scale=FALSE)
```

## Visualize PCA Scores Plot
Let's visualize the original PCA dimension reduction.
```{r}
scores = data.frame(pca_obj[["x"]])
ggplot(scores, aes(x=PC1, y=PC2)) +  
  geom_point() +
  labs(title="CERES Scores Plot", 
       x="PC1", 
       y="PC2") +
  theme(legend.position="none")
```

## Visualize cell line distribution
Let's also get the distribution of the data
```{R}
outlier_id = data.frame(ids)
filtered_cell_lines = merge(meta_data, 
                            outlier_id,
                            by.x='DepMap_ID',
                            by.y='DepMap_ID')
```

Now let's plot it
```{r}
# Group by 
tmp = aggregate(filtered_cell_lines$lineage, 
                by=list(filtered_cell_lines$lineage), 
                length)
tmp = tmp %>% arrange(x)
tmp$Group.1 = factor(tmp$Group.1,
                     levels=tmp$Group.1[order(tmp$x, decreasing = TRUE)])

# Plot by tissue
ggplot(data=tmp, 
       aes(x=Group.1, 
           y=x, 
           fill=x,
           label=x)) +
  geom_bar(stat='identity',
           position='dodge') +
  coord_flip() +
  labs(y="Number of cell lines per tissue",
       x="Tissue lineage",
       title="All intersecting cell lines") + 
  guides(fill=guide_legend(title="N cell lines")) +
  geom_text(aes(label=x), 
            position=position_dodge(width=0.9))
```

## Robust PCA
Now let's remove some outliers using Robust PCA:
```{r}
robpca_ceres = removeOutliers(ceres, ids)

rob_scores = data.frame(robpca_ceres@robpca$scores)
ggplot(rob_scores, aes(x=PC1, y=PC2)) +  
  geom_point() +
  labs(title="CERES Robust PCA Scores Plot", 
       x="PC1", 
       y="PC2") +
  theme(legend.position="none")
```

## Visualize cell lines that are omitted from ROBPCA
I am curious about what cell lines are omitted.
```{R}
outlier_id = data.frame(robpca_ceres@outlier_id)
filtered_cell_lines = merge(meta_data, 
                            outlier_id,
                            by.x='DepMap_ID',
                            by.y='robpca_ceres.outlier_id')
```

## Visualize outlier cell line distribution
Visualize the cell lines that are omitted from downstream analyses.
```{r}
# Group by 
tmp = aggregate(filtered_cell_lines$lineage, 
                by=list(filtered_cell_lines$lineage), 
                length)
tmp = tmp %>% arrange(x)
tmp$Group.1 = factor(tmp$Group.1,
                     levels=tmp$Group.1[order(tmp$x, decreasing = TRUE)])

# Plot by tissue
ggplot(data=tmp, 
       aes(x=Group.1, 
           y=x, 
           fill=x,
           label=x)) +
  geom_bar(stat='identity',
           position='dodge') +
  coord_flip() +
  labs(y="Number of cell lines removed",
       x="Tissue lineage",
       title="Cell lines removed from robust PCA") + 
  guides(fill=guide_legend(title="N cell lines")) +
  geom_text(aes(label=x), 
            position=position_dodge(width=0.9), 
            hjust=-0.25)
```
## Repeat ROBPCA filter for genes
```{r}
tmp = robpca_ceres@data
tmpid = robpca_ceres@id
rownames(tmp) = tmpid
tmp = t(tmp)
tmpid = data.frame(rownames(tmp))
robpca_ceres = removeOutliers(tmp, tmpid)
```

## Construction final dataset for downstream analysis
We'll use the ceres data from the Robust PCA analysis.
```{r}
ceres = t(robpca_ceres@data)
ids = rownames(ceres)
rm(list=c("pca_obj", "robpca_ceres", "robscores", "scores"))
save(list=c("ceres", "ids"), file=savepath)
load(savepath)
```