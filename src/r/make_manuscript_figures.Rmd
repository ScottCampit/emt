---
title: "Manuscript Figures"
output: html_notebook
---

## Summary
This notebook makes heatmaps for publication.

```{r}
rm(list=ls())
```

## Load Libraries
```{r}
library(tidyverse)
library(ggplot2)
library(reshape2)
library(extrafont)
library(ComplexHeatmap)
library(circlize)
#font_import()
loadfonts(device = "win")
```

## 1. Bulk Fluxes

### A. Load Data
First, let's load the data
```{r}
filename = "D:/Analysis/EMT/data/Bulk Flux Intersection.csv"
data = read_csv(filename)
```

### B. Grab the top 50 reactions
```{r}
top50 = data[1:50, ]
rxn_labels = top50[, 2]
bardata = top50[, 4]
expt_data = top50[, 5]
unique(top50$`KEGG Subsystem`)
```

#### i. Reformat the data
```{r}
# Split by hours
early_data = top50[, c("GSE17708_1hr", "Garcia_1hrs")]
mid1_data = top50[, c("GSE17708_8hrs", "GSE147405_8hrs")]
mid2_data = top50[, c("GSE17708_24hrs", "Garcia_24hrs", "GSE147405_24hrs")]
late_data = top50[, c("GSE17708_72hrs", "GSE17518_72hrs", "Garcia_48hrs", 
                       "Keshamouni_72hrs", "GSE147405_72hrs")]
reformat_data = cbind(early_data, mid1_data, mid2_data, late_data)
reformat_data = log(abs(reformat_data))
```

#### ii. Create the column annotation bar for each time-point
```{r}
all_col = HeatmapAnnotation(EMT=c("01hr", "01hr",
                                    "08hrs", "08hrs",
                                    "24hrs", "24hrs", "24hrs",
                                    "72hrs", "72hrs", "72hrs", "72hrs", "72hrs"),
                            col=list(EMT=c("01hr"="#CAC4CE", 
                                           "08hrs"="#8D86C9",
                                           "24hrs"="#725AC1",
                                           "72hrs"="#242038")),
                            annotation_name_side="left")
```

#### iii. Create the barplot that shows the priority score
```{r}
bp = rowAnnotation(
  Priority=anno_barplot(
    bardata
  )
)
```

#### iv. Create a heatmap showing the number of experiments for each reaction
```{r, fig.width=10, fig.height=7.5}
hm = Heatmap(expt_data,
             col = colorRamp2(c(1,5), 
                              c("#FFFFFF", "#95C623")),
             heatmap_legend_param=list(title="Expts",
                                       color_bar="discrete"))
```

#### v. Create the Heatmap with additional figures
```{r}
# OPTIONAL: CHANGE THE TEXT FORMAT
#ht_opt(heatmap_column_names_gp = gpar(fontfamily = "TT Arial"), 
#       heatmap_row_names_gp = gpar(fontfamily = "TT Arial"), 
#       heatmap_column_title_gp = gpar(fontfamily = "TT Arial"),
#       heatmap_row_title_gp = gpar(fontfamily = "TT Arial"),
#       legend_title_gp = gpar(fontfamily = "TT Arial"),
#       legend_labels_gp = gpar(fontfamily = "TT Arial"))
final_data = as.matrix(reformat_data)
rownames(final_data) = top50$`Reaction Name`
ht = Heatmap(final_data, 
             top_annotation=all_col,
             cluster_columns=FALSE,
             cluster_rows=TRUE,
             col = colorRamp2(c(0, 20), c("white", "red")),
             heatmap_legend_param=list(title="Flux")) + 
     rowAnnotation(rn = anno_text(rownames(final_data))) +
     hm + 
     bp
```

#### vi. Save the figure to file
```{r}
png(filename="D:/Analysis/EMT/figures/RECON1_flux_heatmap.png",
       width=10,
       height=10,
       units='in',
    res=1200)
ht
dev.off()
  
```

### C. Visualize Glycolytic Reactions
Now let's specifically get reactions related to Glycolysis.

## 2. Bulk Reaction KOs
```{r}
filename = "D:/Analysis/EMT/data/Bulk Reaction KO Intersection.csv"

```

## 3. Single-Cell Reaction KOs
```{r}
filename = "D:/Analysis/EMT/data/scRNASeq Reaction KO.csv"

```

## Conclusion
